# Layer2 SQL Validation System

A comprehensive system for validating and fixing SQL queries generated by the Layer2 processing pipeline using Vanna AI.

## Overview

This system processes all 522 SQL queries generated from Layer2 output and validates them against actual CSV data schemas using Vanna AI with OpenAI GPT-4o integration.

## Files Structure

```
vanna_sql/
â”œâ”€â”€ vanna_setup.py                    # Core Vanna AI integration
â”œâ”€â”€ validation_config.json            # Configuration settings
â”œâ”€â”€ master_validate_layer2.py         # Main execution script
â”œâ”€â”€ validate_all_layer2_queries.py    # Comprehensive validation
â”œâ”€â”€ process_individual_files.py       # Individual file processing
â”œâ”€â”€ batch_validate_layer2.py          # Batch processing
â”œâ”€â”€ simple_sql_test.py                # Testing framework
â””â”€â”€ validation_results/               # Output directory
```

## Quick Start

### 1. Basic Validation (Recommended)

```bash
python master_validate_layer2.py --method comprehensive
```

This processes all 522 queries from the master file and provides a consolidated report.

### 2. Interactive Mode

```bash
python master_validate_layer2.py
```

Provides an interactive menu to choose validation method.

### 3. Check System Status

```bash
python master_validate_layer2.py --check
```

Verifies that Layer2 output exists and system is ready.

## Validation Methods

### 1. Comprehensive Validation
- **File**: `validate_all_layer2_queries.py`
- **Purpose**: Process master file with all 522 queries
- **Best for**: Overall statistics and consolidated reporting
- **Output**: Single comprehensive report with all query results

```bash
python master_validate_layer2.py --method comprehensive
```

### 2. Individual File Processing
- **File**: `process_individual_files.py`
- **Purpose**: Process each output file separately
- **Best for**: Debugging specific datasets or chart types
- **Output**: Detailed per-file tracking and individual result files

```bash
python master_validate_layer2.py --method individual
```

### 3. Batch Processing
- **File**: `batch_validate_layer2.py`
- **Purpose**: Organize files into logical batches for efficient processing
- **Best for**: Large-scale processing with performance optimization
- **Output**: Batch-organized results with performance metrics

```bash
python master_validate_layer2.py --method batch
```

### 4. All Methods
Run all three validation approaches for comprehensive coverage:

```bash
python master_validate_layer2.py --method all
```

## Input Data Structure

The system processes Layer2 output from:
- `../preprocess/output_layer2/sql_queries/all_sql_queries_complete.json` (Master file)
- `../preprocess/output_layer2/sql_queries/by_dataset/[dataset]/[category]_sql.json`
- `../preprocess/output_layer2/sql_queries/underused_charts/[chart_type]_sql.json`

### Expected Query Structure
```json
{
  "proposition_id": "crime-rates_temporal_001",
  "dataset": "crime-rates",
  "chart_type": "lineChart_simple_2D",
  "sql_query": "SELECT date, count FROM crime_data WHERE ...",
  "variables_needed": ["date", "count", "borough_name"],
  "time_period": "2022-2023"
}
```

## Output Structure

### Validation Results
```
validation_results/
â”œâ”€â”€ layer2_validation_complete.json      # Comprehensive results
â”œâ”€â”€ detailed_validation_summary.json     # Individual file results
â”œâ”€â”€ batch_processing_results.json        # Batch processing results
â”œâ”€â”€ individual_files/                    # Per-file validation results
â”‚   â”œâ”€â”€ crime-rates_temporal_trends_validation.json
â”‚   â””â”€â”€ ...
â””â”€â”€ individual_batches/                  # Per-batch results
    â”œâ”€â”€ dataset_crime-rates_results.json
    â””â”€â”€ ...
```

### Result Structure
Each validated query includes:
- **Original Query**: SQL as generated by Layer2
- **Validated Query**: Fixed SQL from Vanna (if different)
- **Validation Status**: Pass/fail status
- **Errors**: List of validation issues found
- **Suggestions**: Vanna AI suggestions for improvement
- **Performance Metrics**: Processing time and statistics

## Configuration

Edit `validation_config.json` to customize:

### Processing Settings
```json
{
  "processing": {
    "batch_size": 5,
    "delay_between_batches": 2,
    "max_retries": 3,
    "timeout_per_query": 30
  }
}
```

### Dataset Schemas
Each dataset has defined schema mapping:
```json
{
  "crime-rates": {
    "table_name": "crime_data",
    "key_columns": ["borough_name", "crime_category", "date", "count"],
    "date_columns": ["date"],
    "numeric_columns": ["count"]
  }
}
```

### Chart Type Requirements
Validation rules for different chart types:
```json
{
  "comboBarLineChart": {
    "required_columns": ["category", "bar_value", "line_value"],
    "validation_rules": [
      "bar_value must be numeric",
      "line_value must be numeric"
    ]
  }
}
```

## Vanna AI Integration

The system uses Vanna AI with OpenAI GPT-4o for:

1. **SQL Syntax Validation**: Check for syntax errors
2. **Schema Compliance**: Ensure columns exist in target tables
3. **Date Format Validation**: Verify date format consistency
4. **Query Optimization**: Suggest performance improvements
5. **Automatic Fixing**: Correct common SQL issues

### Key Features
- **Date Format Emphasis**: Special validation for date range queries
- **Schema-Aware Corrections**: Uses actual CSV schema information
- **Chart-Type Specific Validation**: Different rules for different chart types

## Troubleshooting

### Common Issues

1. **"Layer2 output directory not found"**
   ```bash
   # Run layer2 processing first
   cd ../preprocess
   node layer2.js
   ```

2. **"Vanna API key missing"**
   ```bash
   # Set OpenAI API key in .env.local
   echo "OPENAI_API_KEY=your_key_here" >> ../../../.env.local
   ```

3. **"CSV data directory not found"**
   ```bash
   # Verify CSV data location
   ls -la ../../data/london_datasets_csv/
   ```

### Debug Mode
Run individual scripts directly for detailed debugging:
```bash
python validate_all_layer2_queries.py
python process_individual_files.py  
python batch_validate_layer2.py
```

## Performance Expectations

- **Comprehensive Validation**: ~5-10 minutes for 522 queries
- **Individual File Processing**: ~10-15 minutes with detailed tracking
- **Batch Processing**: ~8-12 minutes with optimized batching
- **Query Rate**: ~1-2 queries per second (limited by OpenAI API)

## Success Metrics

From Layer2 output (522 queries):
- âœ… **by_dataset**: 330 queries from original layer1 processing
- ðŸ“ˆ **underused_charts**: 192 queries from chart-specific propositions
- ðŸŽ¯ **Expected Success Rate**: 80-90% (based on previous validation)
- ðŸ”§ **Expected Fix Rate**: 10-20% (queries improved by Vanna)

## Next Steps After Validation

1. **SQL Execution**: Use validated queries with `sql_query_executor.js`
2. **Data Generation**: Execute queries against CSV data
3. **Visualization**: Create actual charts using the validated data
4. **Error Analysis**: Review and manually fix any remaining failed queries

## Support

For issues or questions:
1. Check the debug output from individual script runs
2. Review `validation_config.json` for configuration issues  
3. Verify Layer2 output structure matches expected format
4. Test Vanna integration with `simple_sql_test.py`
